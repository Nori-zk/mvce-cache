name: Protect Workflows

on:
  pull_request_target:
    types: [opened, synchronize]

jobs:
  protect-workflows:
    name: protect-workflows
    runs-on: [self-hosted, nori, standard]
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.sha }}
          
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          path: pr-code
          
      - name: Check for workflow changes
        id: check
        continue-on-error: true
        run: |
          echo "Checking for changes in .github/workflows/"
          
          # Get list of changed files in the PR
          cd pr-code
          git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} > /tmp/changed_files.txt
          
          # Check if any workflow files changed
          if grep -q "^\.github/workflows/" /tmp/changed_files.txt; then
            echo "workflow_changed=true" >> $GITHUB_OUTPUT
            echo "Workflow files modified:"
            grep "^\.github/workflows/" /tmp/changed_files.txt | tee /tmp/workflow_files.txt
            exit 1
          else
            echo "workflow_changed=false" >> $GITHUB_OUTPUT
            echo "No workflow files changed"
          fi
      
      - name: Write job summary
        if: always()
        run: |
          if [ -z "$GITHUB_STEP_SUMMARY" ]; then
            echo "ERROR: GITHUB_STEP_SUMMARY not set"
            exit 1
          fi
          
          if [ "${{ steps.check.outputs.workflow_changed }}" == "true" ]; then
            echo "## ⚠️ Workflow Protection Alert" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "Workflow files have been modified in this PR:" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            cat /tmp/workflow_files.txt >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "For security reasons, workflow changes require additional review." >> "$GITHUB_STEP_SUMMARY"
          else
            echo "## ✅ Workflow Protection: PASS" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "No workflow files changed in this PR." >> "$GITHUB_STEP_SUMMARY"
          fi
          
      - name: Fail if workflows changed
        if: steps.check.outputs.workflow_changed == 'true'
        run: exit 1
          
      - name: Comment on PR if workflows changed
        if: failure() && steps.check.outputs.workflow_changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '⚠️ **Workflow Protection Alert**\n\nThis PR attempts to modify workflow files in `.github/workflows/`. For security reasons, workflow changes require additional review.\n\nWorkflow modifications can introduce security vulnerabilities or bypass branch protections. Please have a repository administrator review these changes.'
            });